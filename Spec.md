# OneChunkGuard プラグイン仕様書

## 概要
OneChunkGuardは、Minecraft（Spigot/Paper）サーバー用のプラグインで、各プレイヤーが1つのチャンクのみを保護できるシンプルな土地保護システムを提供します。WorldGuard APIを活用し、初心者にも使いやすい直感的なインターフェースを実現します。

## 主要機能

### 1. 初回ログイン時の保護ブロック配布
- 新規プレイヤーがサーバーに初めて参加した際、自動的に「保護ブロック」を1つ配布
- 保護ブロックは特別なアイテム（例：エンドストーン）として実装
- カスタム名とLoreで識別可能にする
- **保護ブロックはホットバー9番目（スロット8）に固定配置**
- **インベントリ内での移動、チェストへの格納、他プレイヤーへの譲渡は不可**

### 2. チャンク保護システム
- **保護の有効化**: 保護ブロックを設置すると、そのチャンク（16x16ブロック）全体が自動的に保護される
- **保護の解除**: 保護ブロックを破壊すると、チャンクの保護が自動的に解除される
- **1人1チャンク制限**: 各プレイヤーは同時に1つのチャンクのみ保護可能
- **既存保護領域チェック**: 設置しようとするチャンクに既にWorldGuardで保護されている領域が少しでも含まれている場合、設置を拒否
- **親region制限**: 保護チャンクは、指定された親region内にのみ設置可能（コンフィグで設定）

### 3. 視覚的フィードバック
- 保護ブロックの上に自動的にプレイヤーの頭（スカルブロック）を設置
- 誰のチャンクかが一目で分かるように表示
- 保護ブロックと頭は一体として管理

### 6. 共同プレイヤー機能
- チャンク所有者は他のプレイヤーに建築権限を付与可能
- **チャットTUIインターフェース**:
  - 保護ブロックを右クリックでメニュー表示
  - クリック可能なボタンでコマンドを自動入力
  - 「メンバー追加」「メンバー削除」「メンバー一覧」のオプション
- 最大共同プレイヤー数は設定ファイルで調整可能

### 4. 保護ブロックの破壊制限
- 保護ブロックは以下の条件でのみ破壊可能：
  - 保護を設定したプレイヤー本人
  - サーバーオペレーター（OP権限保持者）
- その他のプレイヤーは破壊不可

### 5. コマンドシステム

#### `/unprotect` コマンドの詳細仕様
引数なしの場合は**defaultタイプのみ**を対象とする：

**defaultタイプの動作:**
- 保護されていない場合: 保護ブロックを返却
- 保護されている＆設置されている場合: ブロックを破壊して返却
- 保護されている＆設置なしの場合: 保護ブロックを返却

**default以外のタイプの動作 (`/unprotect <種類>`):**
- 保護されていない場合: 返却なし
- 保護されている＆設置されている場合: ブロックを破壊して返却
- 保護されている＆設置なしの場合: 返却なし

#### その他のコマンド
- `/unprotect [種類]` - 保護を解除し、条件に応じて保護ブロックを返却
  - 権限: なし（全プレイヤー使用可能）
- `/trust <プレイヤー名>` - プレイヤーが保有するチャンクに共同プレイヤーを追加
  - 権限: なし（チャンク所有者のみ使用可能）
- `/untrust <プレイヤー名>` - 共同プレイヤーを削除
  - 権限: なし（チャンク所有者のみ使用可能）
- `/trustlist` - 現在の共同プレイヤー一覧を表示
  - 権限: なし（チャンク所有者と共同プレイヤーが使用可能）
- `/giveprotectionblock <プレイヤー> <種類> [数量]` - 管理者用保護ブロック配布
  - 権限: `onechunkguard.admin`

## 技術仕様

### 依存関係
- Spigot/Paper API 1.20+
- WorldGuard 7.0+
- WorldEdit 7.2+（WorldGuardの依存）

### データ保存
- プレイヤーごとの保護情報をYAMLファイルで管理
- 保護ブロックの位置情報
- 保護されているチャンクの座標
- プレイヤーUUIDとの紐付け
- 共同プレイヤーリスト

### WorldGuard統合
- 各保護チャンクをWorldGuardのリージョンとして登録
- リージョン名: `onechunk_<player_uuid>`
- フラグ設定:
  - BUILD: DENY（所有者・共同プレイヤー以外）
  - INTERACT: DENY（所有者・共同プレイヤー以外）
  - その他必要なフラグ
- 共同プレイヤーはWorldGuardのメンバーシステムを利用

### イベント処理
1. **PlayerJoinEvent**: 初回ログイン判定と保護ブロック配布（ホットバー9番目に配置）
2. **BlockPlaceEvent**: 
   - 保護ブロック設置時のチャンク保護処理
   - 既存WorldGuard保護領域との重複チェック
3. **BlockBreakEvent**: 
   - 保護ブロックの破壊制限チェック
   - 保護解除処理
4. **PlayerInteractEvent**: 
   - 保護ブロックへの不正な操作を防止
   - 右クリック時のチャットTUI表示
5. **InventoryClickEvent**: 保護ブロックのインベントリ内移動を防止
6. **InventoryDragEvent**: 保護ブロックのドラッグ操作を防止
7. **PlayerDropItemEvent**: 保護ブロックのドロップを防止

## 設定ファイル (config.yml)
```yaml
# 保護ブロック種類の設定（複数定義可能）
protection-blocks:
  # デフォルトの保護ブロック
  default:
    material: END_STONE
    display-name: "&6&l保護ブロック"
    lore:
      - "&7このブロックを設置すると"
      - "&7チャンクが保護されます"
      - "&c1人1チャンクまで！"
    parent-region: "spawn_area"  # この親region内にのみ設置可能
    chunk-range: 1               # 保護するチャンクの範囲（1=1x1チャンク）
  
  # VIPプレイヤー用の保護ブロック（例）
  vip:
    material: DIAMOND_BLOCK
    display-name: "&b&lVIP保護ブロック"
    lore:
      - "&7このブロックを設置すると"
      - "&79チャンクが保護されます"
      - "&c1人1種類まで！"
    parent-region: "vip_area"
    chunk-range: 3               # 保護するチャンクの範囲（3=3x3チャンク）

# メッセージ設定
messages:
  protection-created: "&a保護が有効になりました！"
  protection-removed: "&c保護が解除されました！"
  already-protected: "&cすでに別のチャンクを保護しています！"
  cannot-break: "&cこの保護ブロックは破壊できません！"
  unprotect-success: "&a保護を解除し、ブロックを返却しました！"
  no-protection: "&c保護しているチャンクがありません！"
  region-overlap: "&cこのチャンクには既に保護された領域が存在します！"
  cannot-move-item: "&c保護ブロックは移動できません！"
  cannot-drop-item: "&c保護ブロックは捨てることができません！"
  trust-success: "&a{player}を共同プレイヤーに追加しました！"
  untrust-success: "&c{player}を共同プレイヤーから削除しました！"
  trust-limit: "&c共同プレイヤー数が上限に達しています！"
  not-owner: "&cあなたはこのチャンクの所有者ではありません！"
  player-not-found: "&cプレイヤーが見つかりません！"
  outside-parent-region: "&cこの保護ブロックは{region}内でのみ設置できます！"

# 保護設定
protection:
  # 保護する高さの範囲
  min-y: -64
  max-y: 320
  # 共同プレイヤーの最大数
  max-trusted-players: 5

# チャットTUI設定
chat-ui:
  header: "&6═════ チャンク保護設定 ═════"
  add-member: "&a[メンバー追加]"
  remove-member: "&c[メンバー削除]"
  list-members: "&b[メンバー一覧]"
  footer: "&6═══════════════════"
```

## 実装完了機能

### 1. 基本保護システム ✅
- ✅ 初回ログイン時の保護ブロック自動配布（スロット9固定）
- ✅ ブロック設置/破壊によるチャンク保護の有効化/無効化
- ✅ 1人1種類1チャンク制限（複数種類なら複数保護可能）
- ✅ 保護ブロックの破壊制限（所有者とOP権限者のみ）
- ✅ 既存WorldGuard領域との重複チェック（親regionは除外）

### 2. 複数保護ブロック種類対応 ✅
- ✅ コンフィグで複数の保護ブロックタイプを定義可能
- ✅ 各タイプごとの設定：
  - `material`: ブロックの種類
  - `display-name`: 表示名  
  - `lore`: 説明文
  - `parent-region`: 設置可能な親region名
  - `chunk-range`: 保護するチャンク範囲（1=1x1、3=3x3チャンクなど）
- ✅ WorldGuardリージョン名の種類別分離（`onechunk_{種類}_{UUID}`）

### 3. 親region制限システム ✅
- ✅ 保護チャンクは特定の親regionの中にのみ設置可能
- ✅ 設置前に親region内かチェックし、範囲外の場合はエラーメッセージを表示
- ✅ 親regionが存在する場合の重複チェック除外処理

### 4. チャンク範囲拡張 ✅
- ✅ 従来の1チャンク保護に加え、3x3、5x5などの範囲保護に対応
- ✅ 中央のチャンクに保護ブロックを設置すると、指定範囲のチャンクがすべて保護される
- ✅ 既存WorldGuard領域との重複チェックも範囲全体で実施

### 5. UI/UX改善 ✅
- ✅ プレイヤー頭の自動表示（保護ブロック上）
- ✅ チャットTUIインターフェース（右クリックメニュー）
- ✅ アクションバーでの所有者表示（チャンク入場時）
- ✅ チャンクビジュアライザー（パーティクル表示）
- ✅ 保護ブロックのインベントリ操作制限（defaultのみスロット9固定）

### 6. コマンドシステム ✅
- ✅ `/unprotect [種類]` - 保護解除とブロック返却
- ✅ `/trust <プレイヤー名>` - 共同プレイヤー追加（@pセレクター対応）
- ✅ `/untrust <プレイヤー名>` - 共同プレイヤー削除（@pセレクター対応）
- ✅ `/trustlist` - 共同プレイヤー一覧表示
- ✅ `/giveprotectionblock <プレイヤー> <種類> [数量]` - 管理者用配布コマンド（@pセレクター対応）

### 7. セキュリティ・品質改善 ✅
- ✅ UUID基準でのプレイヤー識別
- ✅ NBTタグによる保護ブロック識別（`onechunkguard:type`）
- ✅ 死亡時の保護ブロックドロップ防止
- ✅ インベントリ操作の完全制御
- ✅ 権限システムの統一（`onechunkguard.admin`）
- ✅ 全メッセージの日本語化とコンフィグ化
- ✅ リスナーの目的別整理（9個→5個）

### 8. 保護ブロック種類別動作 ✅
- ✅ **defaultブロック**: スロット9固定、常時返却、初回配布対象
- ✅ **非defaultブロック**: 通常アイテム扱い、実際破壊時のみ返却、管理者配布のみ
- ✅ 遠隔地からの保護ブロック破壊検証ロジック

## 残り課題・改善案

### 1. 未完了のTODO項目
- [ ] 遠隔地のブロック破壊検証の詳細実装（現在は基本実装済み）
- [ ] /unprotectでの種類指定による独立解除機能の拡張
- [ ] 全メッセージのコンフィグ化完了（一部ハードコード残存）
- [ ] defaultブロック以外の通常アイテム化処理

## 実装の優先順位
1. **必須機能**（Phase 1）
   - 初回ログイン時の保護ブロック配布（ホットバー9番目固定）
   - ブロック設置/破壊によるチャンク保護管理
   - 1人1チャンク制限
   - 保護ブロックの破壊制限
   - 既存WorldGuard領域との重複チェック
   - インベントリ操作制限

2. **追加機能**（Phase 2）
   - プレイヤー頭の表示
   - /unprotectコマンド
   - 共同プレイヤー機能（/trust, /untrust, /trustlist）
   - チャットTUIインターフェース
   - 設定ファイルのカスタマイズ

3. **新仕様対応**（v2.0）
   - 親region制限システム
   - 複数保護ブロック種類対応
   - チャンク範囲拡張（1x1から3x3、5x5など）
   - 保護ブロック種類別の権限管理

4. **拡張機能**（将来的な実装）
   - 保護チャンクの視覚的な境界表示
   - 保護の譲渡機能
   - 管理者用コマンド

## パフォーマンス考慮事項
- チャンク保護情報をメモリにキャッシュ
- WorldGuard APIの呼び出しを最小限に抑制
- 非同期処理の活用（可能な箇所）

## セキュリティ考慮事項
- UUID基準でプレイヤーを識別（名前変更対応）
- 権限チェックの厳格な実装
- 不正な保護ブロックの複製防止（NBTタグによる識別）
- インベントリ操作の完全制御（ホットバー9番目固定）
- 既存保護領域への侵害防止