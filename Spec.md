# OneChunkGuard プラグイン仕様書

## 概要
OneChunkGuardは、Minecraft（Spigot/Paper）サーバー用のプラグインで、各プレイヤーが1つのチャンクのみを保護できるシンプルな土地保護システムを提供します。WorldGuard APIを活用し、初心者にも使いやすい直感的なインターフェースを実現します。

## 主要機能

### 1. 初回ログイン時の保護ブロック配布
- 新規プレイヤーがサーバーに初めて参加した際、自動的に「保護ブロック」を1つ配布
- 保護ブロックは特別なアイテム（例：エンドストーン）として実装
- カスタム名とLoreで識別可能にする
- **保護ブロックはホットバー9番目（スロット8）に固定配置**
- **インベントリ内での移動、チェストへの格納、他プレイヤーへの譲渡は不可**

### 2. チャンク保護システム
- **保護の有効化**: 保護ブロックを設置すると、そのチャンク（16x16ブロック）全体が自動的に保護される
- **保護の解除**: 保護ブロックを破壊すると、チャンクの保護が自動的に解除される
- **1人1チャンク制限**: 各プレイヤーは同時に1つのチャンクのみ保護可能
- **既存保護領域チェック**: 設置しようとするチャンクに既にWorldGuardで保護されている領域が少しでも含まれている場合、設置を拒否

### 3. 視覚的フィードバック
- 保護ブロックの上に自動的にプレイヤーの頭（スカルブロック）を設置
- 誰のチャンクかが一目で分かるように表示
- 保護ブロックと頭は一体として管理

### 6. 共同プレイヤー機能
- チャンク所有者は他のプレイヤーに建築権限を付与可能
- **チャットTUIインターフェース**:
  - 保護ブロックを右クリックでメニュー表示
  - クリック可能なボタンでコマンドを自動入力
  - 「メンバー追加」「メンバー削除」「メンバー一覧」のオプション
- 最大共同プレイヤー数は設定ファイルで調整可能

### 4. 保護ブロックの破壊制限
- 保護ブロックは以下の条件でのみ破壊可能：
  - 保護を設定したプレイヤー本人
  - サーバーオペレーター（OP権限保持者）
- その他のプレイヤーは破壊不可

### 5. コマンド
- `/unprotect` - 現在の保護を解除し、保護ブロックをホットバー9番目に返却
  - エイリアス: `/up`
  - 権限: なし（全プレイヤー使用可能）
- `/trust <プレイヤー名>` - プレイヤーが保有するチャンクに共同プレイヤーを追加
  - 権限: なし（チャンク所有者のみ使用可能）
- `/untrust <プレイヤー名>` - 共同プレイヤーを削除
  - 権限: なし（チャンク所有者のみ使用可能）
- `/trustlist` - 現在の共同プレイヤー一覧を表示
  - 権限: なし（チャンク所有者と共同プレイヤーが使用可能）

## 技術仕様

### 依存関係
- Spigot/Paper API 1.20+
- WorldGuard 7.0+
- WorldEdit 7.2+（WorldGuardの依存）

### データ保存
- プレイヤーごとの保護情報をYAMLファイルで管理
- 保護ブロックの位置情報
- 保護されているチャンクの座標
- プレイヤーUUIDとの紐付け
- 共同プレイヤーリスト

### WorldGuard統合
- 各保護チャンクをWorldGuardのリージョンとして登録
- リージョン名: `onechunk_<player_uuid>`
- フラグ設定:
  - BUILD: DENY（所有者・共同プレイヤー以外）
  - INTERACT: DENY（所有者・共同プレイヤー以外）
  - その他必要なフラグ
- 共同プレイヤーはWorldGuardのメンバーシステムを利用

### イベント処理
1. **PlayerJoinEvent**: 初回ログイン判定と保護ブロック配布（ホットバー9番目に配置）
2. **BlockPlaceEvent**: 
   - 保護ブロック設置時のチャンク保護処理
   - 既存WorldGuard保護領域との重複チェック
3. **BlockBreakEvent**: 
   - 保護ブロックの破壊制限チェック
   - 保護解除処理
4. **PlayerInteractEvent**: 
   - 保護ブロックへの不正な操作を防止
   - 右クリック時のチャットTUI表示
5. **InventoryClickEvent**: 保護ブロックのインベントリ内移動を防止
6. **InventoryDragEvent**: 保護ブロックのドラッグ操作を防止
7. **PlayerDropItemEvent**: 保護ブロックのドロップを防止

## 設定ファイル (config.yml)
```yaml
# 保護ブロックの設定
protection-block:
  material: END_STONE
  display-name: "&6&l保護ブロック"
  lore:
    - "&7このブロックを設置すると"
    - "&7チャンクが保護されます"
    - "&c1人1チャンクまで！"

# メッセージ設定
messages:
  protection-created: "&a保護が有効になりました！"
  protection-removed: "&c保護が解除されました！"
  already-protected: "&cすでに別のチャンクを保護しています！"
  cannot-break: "&cこの保護ブロックは破壊できません！"
  unprotect-success: "&a保護を解除し、ブロックを返却しました！"
  no-protection: "&c保護しているチャンクがありません！"
  region-overlap: "&cこのチャンクには既に保護された領域が存在します！"
  cannot-move-item: "&c保護ブロックは移動できません！"
  cannot-drop-item: "&c保護ブロックは捨てることができません！"
  trust-success: "&a{player}を共同プレイヤーに追加しました！"
  untrust-success: "&c{player}を共同プレイヤーから削除しました！"
  trust-limit: "&c共同プレイヤー数が上限に達しています！"
  not-owner: "&cあなたはこのチャンクの所有者ではありません！"
  player-not-found: "&cプレイヤーが見つかりません！"

# 保護設定
protection:
  # 保護する高さの範囲
  min-y: -64
  max-y: 320
  # 共同プレイヤーの最大数
  max-trusted-players: 5

# チャットTUI設定
chat-ui:
  header: "&6═════ チャンク保護設定 ═════"
  add-member: "&a[メンバー追加]"
  remove-member: "&c[メンバー削除]"
  list-members: "&b[メンバー一覧]"
  footer: "&6═══════════════════"
```

## 実装の優先順位
1. **必須機能**（Phase 1）
   - 初回ログイン時の保護ブロック配布（ホットバー9番目固定）
   - ブロック設置/破壊によるチャンク保護管理
   - 1人1チャンク制限
   - 保護ブロックの破壊制限
   - 既存WorldGuard領域との重複チェック
   - インベントリ操作制限

2. **追加機能**（Phase 2）
   - プレイヤー頭の表示
   - /unprotectコマンド
   - 共同プレイヤー機能（/trust, /untrust, /trustlist）
   - チャットTUIインターフェース
   - 設定ファイルのカスタマイズ

3. **拡張機能**（将来的な実装）
   - 保護チャンクの視覚的な境界表示
   - 保護の譲渡機能
   - 管理者用コマンド

## パフォーマンス考慮事項
- チャンク保護情報をメモリにキャッシュ
- WorldGuard APIの呼び出しを最小限に抑制
- 非同期処理の活用（可能な箇所）

## セキュリティ考慮事項
- UUID基準でプレイヤーを識別（名前変更対応）
- 権限チェックの厳格な実装
- 不正な保護ブロックの複製防止（NBTタグによる識別）
- インベントリ操作の完全制御（ホットバー9番目固定）
- 既存保護領域への侵害防止